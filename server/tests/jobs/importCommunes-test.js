const assert = require("assert");
const { createStream } = require("../utils/testUtils");
const importCommunes = require("../../src/jobs/importCommunes");
const { dbCollection } = require("../../src/common/db/mongodb");

let getDatagouvFile = (content) => {
  return createStream(
    content ||
      `{"type":"FeatureCollection", "features": [
{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[4.904966116128047,46.16078590428586],[4.902795914320744,46.15795238219552],[4.905909682131221,46.15730839990226],[4.911571078150266,46.15157695749225],[4.913175140355663,46.146747090292806],[4.915817125164552,46.144171161119765],[4.914118706358837,46.14056486027751],[4.909306519742649,46.13599258599537],[4.908079883938522,46.13322346213435],[4.909212163142331,46.12923077191614],[4.920251885379472,46.12691243566041],[4.921761590984551,46.12452970117535],[4.9222333739861375,46.120279418039836],[4.926196351199471,46.11995742689321],[4.935726367831534,46.125560072844564],[4.938085282839469,46.127427621495016],[4.940821624248675,46.13219309046514],[4.939594988444548,46.13921249746166],[4.941859546852167,46.1447507451837],[4.946199950466769,46.148936630089885],[4.947898369272484,46.14958061238315],[4.953276695490579,46.148485842484604],[4.958371951907719,46.153251311454724],[4.945256384463595,46.15717960344361],[4.937047360235977,46.162009470643056],[4.931480320817248,46.16226706356036],[4.931197251016296,46.16387701929351],[4.9328956698220106,46.16799850597037],[4.937424786637247,46.17076762983138],[4.94025548464677,46.17591948817746],[4.9388401356420095,46.17798023151589],[4.9328956698220106,46.18338968277927],[4.929593188810899,46.183518479237925],[4.9263850644001055,46.18248810756871],[4.921572877783917,46.18261690402736],[4.9146848459607435,46.1837116739259],[4.909023449941697,46.17888180672645],[4.907608100936934,46.17025244399677],[4.905532255729951,46.16574456794396],[4.904966116128047,46.16078590428586]]]},"properties":{"codgeo":"01001","libgeo":"L'Abergement-Clémenciat","dep":"01","reg":"84","xcl2154":848241,"ycl2154":6563021}}
]}`
  );
};

describe("importCommunes", () => {
  it("Vérifie qu'on peut importer les communes", async () => {
    let stats = await importCommunes({
      input: getDatagouvFile(),
    });

    assert.deepStrictEqual(stats, { total: 1, created: 1, updated: 0, failed: 0 });
    const found = await dbCollection("communes").findOne();
    assert.deepStrictEqual(found, {
      _id: "01001",
      geometry: {
        type: "Polygon",
        coordinates: [
          [
            [4.904966116128047, 46.16078590428586],
            [4.902795914320744, 46.15795238219552],
            [4.905909682131221, 46.15730839990226],
            [4.911571078150266, 46.15157695749225],
            [4.913175140355663, 46.146747090292806],
            [4.915817125164552, 46.144171161119765],
            [4.914118706358837, 46.14056486027751],
            [4.909306519742649, 46.13599258599537],
            [4.908079883938522, 46.13322346213435],
            [4.909212163142331, 46.12923077191614],
            [4.920251885379472, 46.12691243566041],
            [4.921761590984551, 46.12452970117535],
            [4.9222333739861375, 46.120279418039836],
            [4.926196351199471, 46.11995742689321],
            [4.935726367831534, 46.125560072844564],
            [4.938085282839469, 46.127427621495016],
            [4.940821624248675, 46.13219309046514],
            [4.939594988444548, 46.13921249746166],
            [4.941859546852167, 46.1447507451837],
            [4.946199950466769, 46.148936630089885],
            [4.947898369272484, 46.14958061238315],
            [4.953276695490579, 46.148485842484604],
            [4.958371951907719, 46.153251311454724],
            [4.945256384463595, 46.15717960344361],
            [4.937047360235977, 46.162009470643056],
            [4.931480320817248, 46.16226706356036],
            [4.931197251016296, 46.16387701929351],
            [4.9328956698220106, 46.16799850597037],
            [4.937424786637247, 46.17076762983138],
            [4.94025548464677, 46.17591948817746],
            [4.9388401356420095, 46.17798023151589],
            [4.9328956698220106, 46.18338968277927],
            [4.929593188810899, 46.183518479237925],
            [4.9263850644001055, 46.18248810756871],
            [4.921572877783917, 46.18261690402736],
            [4.9146848459607435, 46.1837116739259],
            [4.909023449941697, 46.17888180672645],
            [4.907608100936934, 46.17025244399677],
            [4.905532255729951, 46.16574456794396],
            [4.904966116128047, 46.16078590428586],
          ],
        ],
      },
      properties: {
        codgeo: "01001",
        libgeo: "L'Abergement-Clémenciat",
        dep: "01",
        reg: "84",
        xcl2154: 848241,
        ycl2154: 6563021,
      },
      type: "Feature",
    });
  });
});
